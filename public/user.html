<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>صفحة العميل</title>
  <script>
    let currentPhone = null;

    async function loginUser() {
      const phone = document.getElementById("phone").value;
      const res = await fetch("/api/users/" + phone);
      const data = await res.json();

      if (data.error) {
        alert("الرقم غير مسجل، تواصل مع الأدمن");
        return;
      }

      currentPhone = phone;

      document.getElementById("login").style.display = "none";
      document.getElementById("panel").style.display = "block";

      document.getElementById("uname").textContent = data.name;
      document.getElementById("ustatus").textContent = data.subscription.status;
      document.getElementById("uend").textContent = new Date(data.subscription.endDate).toLocaleString();
      document.getElementById("ucount").textContent = data.messagesSent || 0;

      // QR Code من السيرفر
      document.getElementById("qr").src = "/api/qr/" + phone + "?t=" + Date.now();

      // رابط الويب هوك
      const webhook = document.getElementById("webhook");
      webhook.textContent = window.location.origin + "/webhook/" + phone;
      webhook.href = window.location.origin + "/webhook/" + phone;

      // رسالة مخصصة
      document.getElementById("messageTemplate").value = data.messageTemplate || "";
    }

    async function saveTemplate() {
      const msg = document.getElementById("messageTemplate").value;
      if (!currentPhone) return alert("سجّل الدخول أولاً");

      const res = await fetch("/api/users/" + currentPhone + "/template", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messageTemplate: msg })
      });

      const data = await res.json();
      alert(data.message || "تم الحفظ");
    }
  </script>
</head>
<body>
  <div id="login">
    <h2>تسجيل دخول العميل</h2>
    <input id="phone" placeholder="رقم الهاتف"><br>
    <button onclick="loginUser()">دخول</button>
  </div>

  <div id="panel" style="display:none">
    <h2>مرحباً <span id="uname"></span></h2>
    <p>الحالة: <span id="ustatus"></span></p>
    <p>تاريخ الانتهاء: <span id="uend"></span></p>
    <p>عدد الرسائل المرسلة: <span id="ucount"></span></p>

    <p>امسح QR Code للاتصال:</p>
    <img id="qr" width="250" height="250"><br>

    <p>رابط الويب هوك: <a id="webhook" target="_blank"></a></p>

    <h3>الرسالة المخصصة</h3>
    <textarea id="messageTemplate" rows="4" cols="40" placeholder="اكتب رسالتك هنا..."></textarea><br>
    <button onclick="saveTemplate()">حفظ الرسالة</button>
  </div>
</body>
</html>


    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/user.js"></script>
</body>
</html>