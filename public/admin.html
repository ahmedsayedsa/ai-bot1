<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم الأدمن</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 500px; margin-top: 50px; }
    #qr-container { text-align: center; margin-top: 20px; }
    #qr-container img { max-width: 100%; height: auto; }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center mb-4">تسجيل دخول الأدمن</h2>
  <form id="loginForm">
    <div class="mb-3">
      <label for="username" class="form-label">اسم المستخدم</label>
      <input type="text" class="form-control" id="username" required>
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">كلمة المرور</label>
      <input type="password" class="form-control" id="password" required>
    </div>
    <button type="submit" class="btn btn-primary w-100">دخول</button>
  </form>

  <div id="qr-container" class="mt-4" style="display:none;">
    <h5>رمز الـ QR</h5>
    <img id="qr-image" alt="QR Code">
  </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async function (e) {
  e.preventDefault(); // منع إعادة تحميل الصفحة

  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  try {
    const res = await fetch('/api/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user: username, pass: password }),
      credentials: 'include'
    });

    const data = await res.json();
    console.log('Login Response:', data);

    if (res.ok) {
      alert('تم تسجيل الدخول بنجاح');
      loadQRCode();
    } else {
      alert(data.message || 'خطأ في تسجيل الدخول');
    }
  } catch (err) {
    console.error('Error during login:', err);
    alert('حصل خطأ في الاتصال بالسيرفر');
  }
});

async function loadQRCode() {
  try {
    const res = await fetch('/api/admin/qr', { credentials: 'include' });
    if (!res.ok) throw new Error('فشل تحميل QR Code');
    const blob = await res.blob();
    const imgUrl = URL.createObjectURL(blob);
    document.getElementById('qr-image').src = imgUrl;
    document.getElementById('qr-container').style.display = 'block';
  } catch (err) {
    console.error('Error loading QR Code:', err);
    alert('تعذر تحميل رمز الـ QR');
  }
}
</script>

</body>
</html>
